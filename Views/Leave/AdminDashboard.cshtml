@model List<LeaveManagementSystem.Models.LeaveRequest>

@{
    ViewData["Title"] = "Admin Dashboard";
    var query = ViewContext.HttpContext.Request.Query;
    var status = query["status"].ToString();
    var keyword = query["keyword"].ToString();
}

<h2>All Leave Requests</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">
        @TempData["Message"]
    </div>
}

@if (ViewBag.Summary != null)
{
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5>Total Requests</h5>
                    <h3>@ViewBag.Summary["Total"]</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5>Approved</h5>
                    <h3>@ViewBag.Summary["Approved"]</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5>Rejected</h5>
                    <h3>@ViewBag.Summary["Rejected"]</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5>Pending</h5>
                    <h3>@ViewBag.Summary["Pending"]</h3>
                </div>
            </div>
        </div>
    </div>
}

@if (ViewBag.MonthlyData != null)
{
    <p>Monthly Data Count: @(ViewBag.MonthlyData != null ? ((Dictionary<string, int>)ViewBag.MonthlyData).Count : 0)</p>

    <div class="mb-5">
        <h4>
            <a class="text-decoration-none" data-bs-toggle="collapse" href="#monthlyChart" role="button" aria-expanded="false" aria-controls="monthlyChart">
                Monthly Leave Trends
            </a>
        </h4>
        <div class="collapse" id="monthlyChart">
            <canvas id="leaveChart" width="100%" height="40" style="border:1px solid #ccc;"></canvas>
        </div>
    </div>
}

<form method="get" asp-action="AdminDashboard" class="row mb-3">
    <div class="col-md-3">
        <select name="status" class="form-select">
            <option value="">-- Filter by Status --</option>
            <option value="Pending" selected="@(status == "Pending")">Pending</option>
            <option value="Approved" selected="@(status == "Approved")">Approved</option>
            <option value="Rejected" selected="@(status == "Rejected")">Reje cted</option>
        </select>
    </div>
    <div class="col-md-3">
        <input type="text" name="keyword" class="form-control" placeholder="Search by Employee ID or Leave Type" value="@keyword" />
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
</form>

<form method="get" asp-action="ExportToExcel" class="mb-3">
    <input type="hidden" name="status" value="@status" />
    <input type="hidden" name="keyword" value="@keyword" />
    <button type="submit" class="btn btn-outline-success">Export to Excel</button>
</form>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Employee ID</th>
            <th>Employee Name</th>
            <th>Leave Type</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var leave in Model)
        {
            <tr>
                <td>@leave.Id</td>
                <td>@leave.EmployeeId</td>
                <td>@leave.EmployeeName</td>
                <td>@leave.LeaveType</td>
                <td>@leave.StartDate.ToString("dd-MM-yyyy")</td>
                <td>@leave.EndDate.ToString("dd-MM-yyyy")</td>
                <td>@leave.Reason</td>
                <td>@leave.Status</td>
                <td>
                    @if (leave.Status == "Pending")
                    {
                        <form asp-action="UpdateStatus" method="post" style="display:inline;">
                            <input type="hidden" name="id" value="@leave.Id" />
                            <button type="submit" name="status" value="Approved" class="btn btn-success btn-sm">Approve</button>
                            <button type="submit" name="status" value="Rejected" class="btn btn-danger btn-sm">Reject</button>
                        </form>
                    }
                    else
                    {
                        <span class="text-muted">No action</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Bootstrap and Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let chartRendered = false;

    function renderLeaveChart() {
        const ctx = document.getElementById('leaveChart')?.getContext('2d');
        if (!ctx) return;

        console.log("Chart.js loaded:", typeof Chart !== "undefined");
        console.log("Rendering chart...");

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", ((Dictionary<string, int>)ViewBag.MonthlyData).Keys.Select(m => $"'{m}'")))],
                datasets: [{
                    label: 'Leave Requests',
                    data: [@Html.Raw(string.Join(",", ((Dictionary<string, int>)ViewBag.MonthlyData).Values))],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });

        chartRendered = true;
    }

    document.getElementById('monthlyChart')?.addEventListener('shown.bs.collapse', function () {
        if (!chartRendered) renderLeaveChart();
    });

    setTimeout(() => {
        if (!chartRendered && document.getElementById('monthlyChart')?.classList.contains('show')) {
            renderLeaveChart();
        }
    }, 1000);
</script>
